# React Fiber 架构

1. react 的定位：用 JavaScript 构建快速响应的大型 web 应用程序的首选方式。

2. JavaScript 是单线程的，浏览器是多线程的

- 对于多线程的浏览器来说，它除了要处理 JavaScript 线程以外，还需要处理包括事件系统、定时器/延时器、网络请求等各种各样的任务线程，这其中，自然也包括负责处理 DOM 的 UI 渲染线程。而 JavaScript 线程是可以操作 DOM 的。

3. react 页面为什么会“卡顿”？

- JavaScript 对主线程超时占用
- **stack reconciler 是一个同步的递归过程。**

## 问答

Q1：react16 在所有情况下都是异步渲染的吗？

Q2：fiber 架构中的“可中断”“可恢复”到底是如何实现的？

Q3：fiber 树和传统虚拟 DOM 树有什么不同？

Q4：优先级调度是如何实现的？

## 迭代动机

## 架构思想

1. 什么是 Fiber?

Fiber 是比线程还要纤细的一个过程，即“纤程”。纤程的出现意在对渲染过程实现更加精细的控制。

2. 理解 Fiber 的多意：

- 从架构来看，Fiber 是对 react 核心算法(调和过程)的重写
- 从编码角度看，Fiber 是 react 内部定义的一种数据结构，是 fiber 树结构的节点单位，即 react16 新架构下的“虚拟 DOM”
- 从工作流的角度来看，fiber 节点保存了组件需要更新的状态和副作用，一个 fiber 同时对应一个工作单元。

## fiber 架构核心：可中断、可恢复和优先级

1. 三层架构：

- scheduler - 调度更新的优先级

- Reconciler - 找不同

- Renderer - 渲染“不同”

## 要点

1. 如果渲染线程和 JavaScript 线程同时工作，那渲染结果难以预测。

**tips：JavaScript 线程和渲染线程必须是互斥的 - 当其中一个线程执行时，另一个线程只能挂起等待。**

2. fiber 架构的应用目的是实现“增量渲染”

所谓“增量渲染”，通俗来说就是把一个渲染任务分解为多个渲染任务，而后将其分散到多个帧里面

3. **实现增量渲染的目的，是为了实现任务的可中断、可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验。**
