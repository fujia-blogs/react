# react 渲染异常

1. 如果渲染异常，在没有任何降级保护措施的情况下，页面会直接显示白屏。

2. 在类似会产⽣什么影响或者会造成什么后果的问题后，紧接着会询问你怎么做，这就需要你给出⼀个⽅案来解决问题。所以这类问题的中⼼会发⽣偏移，从是什么到怎么做，即从解释原理到提供⽅案。

## 问答

Q1：如何评判方案的优劣呢？

- 解决问题
- 预防问题，在问题处理中以预防为主，通常会讲⾃⼰在初始化项⽬后，会做这样⼏条措施以预防同类的低级错误。
- 工程化方案

Q2：如何量化成果？

## 解决渲染异常

### 是什么？

1. 现象

官方团队：

`组件内的 JavaScript 错误会导致 React 的内部状态被破坏，并且在下⼀次渲染时产⽣可能⽆法追踪的 错误。这些错误基本上是由较早的其他代码（⾮ React 组件代码）错误引起的，但 React并没有提供⼀种在组件中优雅处理这些错误的⽅式，也⽆法从错误中恢复。`

简⽽⾔之，如果有 JavaScript 的错误出现在 React 内部渲染层，就会导致整个应⽤的崩溃。从现象上来看，就是整个界⾯从⻚⾯中被移除掉，也就展现出了所谓的⽩屏。

2. 原理

### 怎么解决？如何工程化？

#### 通用方案

1. 错误边界：

- getDerivedStateFromError
- componentDidCatch

#### 量化结果

1. 在预防层⾯，需要看空安全⽅案在项⽬中的覆盖量，从⽽保证团队内项⽬都将空安全⽤了起来。

2. 在兜底层⾯，同样需要保障⽅案在项⽬中的覆盖量，其次需要统计兜底⻚⾯成功兜底的次数，最后兜底⻚⾯展示时，能够及时完成线上报警。

#### 预防

1. 预防就需要先知道病灶在哪⾥？既然是渲染异常，就需要分析异常会出现在哪⾥。在渲染层，也就是 render 中 return 后的 JSX，都是在进⾏\*_数据的拼装与转换：_

- 在拼装的过程中出现错误，那直接会导致编译的失败；
- 在转换的过程中出现错误，就很不容易被发现；

2. 有没有优雅的解决⽅案呢？有，就是 ES2020 中的 Optional chaining，中⽂叫作可选链操作符

注意：并不是所有浏览器都⽀持该特性，但可以通过引⼊ Babel 插件保障浏览器兼容性。

```json
{
  "plugins": ["@babel/plugin-proposal-optional-chaining"]
}
```

#### 兜底

1. **兜底应该限制崩溃的层级**，错误边界加到哪里，崩溃就止步于哪里，其它组件还可以正常使用，所以只需要给关键的 UI 组件添加错误边界。

2. 使用 - 在组件上挂上注解即可。

```jsx
@errorBoundary
export default class UserProfile {}
```

**建议：类似的方案可以在团队内部抽取为一个 npm 包，提供能力复用。**

## 要点

1. 做前端实际上也是在做工程，需要**工程化的角度**去思考方案该怎么做。

2. 工程化**通常以标准化为抓手**完成降本增效：

- 模块标准化
- 流程标准化
- 代码风格标准化

3. 通过标准化的⽅案解决同类型的问题。即在解决的过程中需要考虑减少⼈为因素，引⼊⾃动化过程。

4. **在解决同类型的问题时**，沉淀的标准化方案，才能用于更多的业务方向，在团队内部才更具有通用价值。

5. 只解决⾃⼰所遇到的问题，贡献度是很低的，**如果能够产出通⽤的⽅案供团队使⽤，就⾮常有价值了**。同时是否具备团队视野会影响⾯试官对个⼈能⼒的评定。

6. 项⽬价值也好，业绩贡献也好，最后都需要数据⽀撑，如果只是空⼝⼀句修复了 Bug，⽽没有提供任何参考性的指标，那就没有任何意义。**⼯程是⼀⻔重视过程与结果的科学，不仅需要注重实施⽅案，也需要注重结果的量化。**

7. 完整的方案通常从**预防和兜底两个维度去解决问题。**

8. 做了很多事情，如何评估做的好不好呢？

需要用数据说话，来评估做的事情到底有没有价值。

9. 量化的结果工作主要从**覆盖**与**统计**两个方向展开。

10. 有基本数据支撑下，去描述一件事，会更立体，让人更容易理解这件事的价值，也更加让人信服。
